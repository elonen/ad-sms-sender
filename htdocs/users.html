<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>
<body>

<!-- instructions for selecting users -->
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Select SMS recipients</h1>
            <p>Select users who you want to send an SMS to.<br/>
                <em>This lists users who have 'Mobile' field set in Active Directory, under 'Telephones'</em>
            </p>
        </div>
    </div>
</div>

<script>
    function toggleAll() {
        var checkboxes = $('.checkbox');
        checkboxes.prop('checked', !checkboxes.prop('checked'));
    }

    function set_status_text(elem, text, color, do_blink=true)
    {
        $(elem).text(text);
        $(elem).css('color', color);
        if (do_blink)
            $(elem).fadeOut(500).fadeIn(500);
    }

    function send_sms_ajax(guid, message)
    {
        var status = $('#status_' + guid);
        set_status_text(status, 'Sending...', 'brown');

        $.ajax({
            url: '/send_sms',
            type: 'POST',
            data: JSON.stringify({guid: guid, message: message}),
            mimetype: 'application/json',
            error: function(xhr, status, error) {
                var status = $('#status_' + guid);
                set_status_text(status, 'HTTP error: ' + error, 'red');
            },
            success: function(data) {
                var status = $('#status_' + guid);
                if (data.error)
                    set_status_text(status, 'Error: ' + data.error, 'red');
                else {
                    set_status_text(status, 'Sent', 'green');
                    $('#checkbox_' + guid).prop('checked', false);
                }
            }
        });
    }

    function scroll_back_to_user_table()
    {
        $('html, body').animate({
            scrollTop: $("#userTable").offset().top
        }, 500);
    }

    function send_to_all_selected()
    {
        // Sanitize the message
        error = false;
        var sms_message = $('#message').val().trim();
        if (sms_message.length > 160)
            error = "Message is too long. 160 characters max.";
        if (sms_message.length == 0)
            error = "Message is empty. Refusing to send.";

        if (error) {
            alert(error);
            scroll_back_to_user_table();
            return;
        }

        // Get the selected users and send SMS
        var selected_count = 0;
        var checkboxes = $('.checkbox');
        checkboxes.each(function() {
            if ($(this).prop('checked')) {
                selected_count++;
                guid = $(this).val();
                send_sms_ajax(guid, sms_message);
            }
        });

        if (selected_count == 0)
            alert('Please select at least one user.');

        scroll_back_to_user_table();
    }
</script>
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div id="query_status"></div>

            <table class="table table-striped table-bordered" id="userTable">
                <thead>
                <tr>
                    <th>
                        <input type="checkbox" onclick="toggleAll(this)">
                    </th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>

                <script>
                    function refresh_table()
                    {
                        set_status_text($('#query_status'), 'Fetching users...', 'brown', false);
                        $('#query_status').show();

                        // empty table except header
                        $('#userTable').find('tr:gt(0)').remove();

                        function fetch_user_rows()
                        {
                            $.ajax({
                                url: 'users_json',
                                dataType: 'json',
                                success: function(data) {

                                    <!-- handle error message from data -->
                                    if (data.error)
                                        $('#query_status').html('<td colspan="4" style="color: red"><em>BACKEND ERROR:</em><pre>' + data.error + '</pre></td>');
                                    else {
                                        $('#fetching_please_wait').hide();
                                        $.each(data, function(index, user) {
                                            //console.log(user);
                                            $('#userTable').append(
                                                '<tr>' +
                                                '<td><input type="checkbox" class="checkbox" value="' + user.guid + '" id="checkbox_' + user.guid + '" /></td>' +
                                                '<td>' + user.user + '</td>' +
                                                '<td>' + user.mobile + '</td>' +
                                                '<td id="status_' + user.guid + '"> - </td>' +
                                                '</tr>'
                                            );
                                        });

                                        $('#query_status').hide();
                                        $('#send_message_container').show();
                                    }
                                },
                                error: function() {
                                    $('#query_status').html('<td colspan="4" style="color: red"><em>An error occurred while fetching users.</em></td>');
                                }
                            });
                        }
                        setTimeout(fetch_user_rows, 500);
                    }
                    refresh_table();
                </script>

                </tbody>
            </table>

            <button type="button" class="btn btn-primary" onclick="refresh_table();">Refresh</button>

            <!-- initially hidden container for typing and sending the message -->
            <div id="send_message_container" style="display: none; margin-top: 1em">
                <div class="row">
                    <div class="col-md-12">
                        <form id="send_message_form">
                            <div class="form-group">
                                <label for="message">Message</label>
                                <textarea class="form-control" id="message" rows="3"></textarea>
                            </div>
                            <script>
                                <!-- limit the message to 160 characters -->
                                $('#message').keyup(function() {
                                    var message = $(this).val();
                                    if (message.length > 160) {
                                        $(this).val(message.substring(0, 160));
                                    }
                                });
                            </script>
                            <button type="button" style="margin-top: 0.5em" class="btn btn-warning" onclick="send_to_all_selected()">Send SMS</button>
                        </form>
                    </div>
                </div>

        </div>
    </div>
</div>


</body>
</html>
